services:
  mcsd-update-client:
    build:
      context: ../
      dockerfile: docker/Dockerfile
      args:
        NEW_UID: ${NEW_UID:-1000}
        NEW_GID: ${NEW_GID:-1000}
    ports:
      - "8509:8509"
    environment:
      DO_NOT_USE_ON_PRODUCTION: "I'm a fool if I run this application on a production environment."
    volumes:
      - ../app:/src/app
      - ../docker:/src/docker
      - ../seeds:/src/seeds
      - ../sql:/src/sql
      - ../tests:/src/tests
      - ../tools:/src/tools
      - ../secrets:/src/secrets
      - ../poetry.lock:/src/poetry.lock
      - ../pyproject.toml:/src/pyproject.toml
      - ../Makefile:/src/Makefile
      - ../README.md:/src/README.md
    configs:
      - source: mcsd_update_client_conf
        target: /src/app.conf
      - source: directory_urls_json
        target: /src/directory_urls.json
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8509/health"]
      start_period: 30s
      interval: 30m
    depends_on:
      postgres:
        condition: service_healthy
      hapi-update-client-health:
        condition: service_healthy
      hapi-directory-health:
        condition: service_healthy
    stop_signal: SIGKILL
    networks:
      - mcsd_update_client_net
    restart: unless-stopped

  hapi-update-client:
    image: "hapiproject/hapi:latest"
    ports:
      - "8081:8081"
    configs:
      - source: hapi_update_client_config
        target: /app/config/application.yaml
    depends_on:
      - postgres
    networks:
      - mcsd_update_client_net
    restart: unless-stopped

  # Can be tested with on the host machine with:
  # curl -k --resolve mach2.disyepd.com:443:127.0.0.1 https://mach2.disyepd.com/notifiedpull/fhir
  hapi-notifiedpull-stu3:
    image: "hapiproject/hapi:latest"
    ports:
      - "8082:8082"
    configs:
      - source: hapi_notifiedpull_stu3_config
        target: /app/config/application.yaml
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
    networks:
      - mcsd_update_client_net
    restart: unless-stopped

  # fills the notifiedpull-stu3 server with seed data placed in notifiedpull-stu3.bundle.json
  notifiedpull-seed:
    image: curlimages/curl
    depends_on:
      hapi-notifiedpull-stu3-health:
        condition: service_healthy
    volumes:
      - ./notifiedpull-stu3.bundle.json:/seed/bundle.json:ro
    entrypoint:
      - sh
      - -c
      - >
          curl -f --retry 10 --retry-connrefused --retry-delay 2
          -H 'Content-Type: application/fhir+json'
          --data-binary @/seed/bundle.json
          http://hapi-notifiedpull-stu3:8082/fhir
    networks:
      - mcsd_update_client_net
    restart: "no"

  # Can be tested with on the host machine with:
  # curl -k --resolve mach2.disyepd.com:443:127.0.0.1 https://mach2.disyepd.com/fhir
  hapi-directory:
    image: "hapiproject/hapi:latest"
    configs:
      - source: hapi_directory_config
        target: /app/config/application.yaml
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mcsd_update_client_net
    restart: unless-stopped

  caddy:
    build:
      context: .
      dockerfile: caddy/Dockerfile
    ports:
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    secrets:
      - cloudflare_api_token
    command:
      [
        "sh",
        "-c",
        "export CLOUDFLARE_API_TOKEN=$$(cat /run/secrets/cloudflare_api_token) && caddy run --config /etc/caddy/Caddyfile --adapter caddyfile",
      ]
    depends_on:
      - hapi-directory
    networks:
      - mcsd_update_client_net
    restart: unless-stopped

  hapi-update-client-health:
    image: curlimages/curl
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://hapi-update-client:8081/actuator/health",
        ]
      start_period: 100s
      start_interval: 5s
    depends_on:
      - hapi-update-client
    stop_signal: SIGKILL
    networks:
      - mcsd_update_client_net
    command: sleep infinity

  hapi-notifiedpull-stu3-health:
    image: curlimages/curl
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "hapi-notifiedpull-stu3:8082/actuator/health/",
        ]
      start_period: 100s
      start_interval: 5s
    depends_on:
      - hapi-notifiedpull-stu3
    stop_signal: SIGKILL
    networks:
      - mcsd_update_client_net
    command: sleep infinity

  hapi-directory-health:
    image: curlimages/curl
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "hapi-directory:8080/actuator/health",
        ]
      start_period: 100s
      start_interval: 5s
    depends_on:
      - hapi-directory
    stop_signal: SIGKILL
    networks:
      - mcsd_update_client_net
    command: sleep infinity

  redis:
    image: redis:latest
    restart: "no"
    command: ["redis-server", "--port", "16379"]
    ports:
      - "16379:16379"
    networks:
      mcsd_update_client_net:
        aliases:
          - external-cache

  postgres:
    image: postgres:15
    healthcheck:
      test: ["CMD-SHELL", "pg_isready --user postgres"]
      start_period: 30s
      interval: 30m
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
    ports:
      - "5432:5432"
    volumes:
      - ./create-dbs.sql:/docker-entrypoint-initdb.d/create-db.sql
    networks:
      - mcsd_update_client_net
    restart: unless-stopped

configs:
  mcsd_update_client_conf:
    file: app.conf
  directory_urls_json:
    file: directory_urls.json
  hapi_update_client_config:
    file: client.application.yaml
  hapi_notifiedpull_stu3_config:
    file: notifiedpull-stu3.application.yaml
  hapi_directory_config:
    file: directory.application.yaml

secrets:
  cloudflare_api_token:
    file: ../secrets/cloudflare_api_token

volumes:
  caddy_data:
  caddy_config:

networks:
  mcsd_update_client_net:
    driver: bridge
    name: mcsd_update_client_net
